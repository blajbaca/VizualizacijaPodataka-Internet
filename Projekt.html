<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <title>Projekt</title>
    <style>
        path {
            fill: none;
            stroke: black;
            stroke-width: 0.5;
        }

        #container {
            display: flex;
        }

        #map-container {
            flex: 1;
            position: relative;
        }

        #chart-container {
            flex: 1;
        }

        #legend-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .legend-text {
            font-size: 10px;
            fill: black;
        }
    </style>
</head>

<body>
    <div>
        <label for="year">Year:</label>
        <input type="range" id="year" min="1980" max="2020" step="1" value="1980">
        <span id="yearValue">1980</span>
    </div>
    <div>
        <label for="variable">Variable:</label>
        <select id="variable">
            <option value="InternetUsersPercentage">Internet Users (%)</option>
            <option value="CellularSubscription">Cellular Subscription</option>
            <option value="BroadbandSubscription">Broadband Subscription</option>
        </select>
    </div>
    <div id="container">
        <div id="map-container">
            <svg id="map" width="800" height="600"></svg>
            <div id="legend-container"></div>
        </div>

        <div id="chart-container">
            <svg id="chart" width="800" height="600"></svg>
        </div>
    </div>

    <script>
        const width = 800;
        const height = 600;

        const svg = d3.select("#map")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", function () {
                g.attr("transform", d3.zoomTransform(this));
            });

        svg.call(zoom);

        const projection = d3.geoNaturalEarth1()
            .translate([width / 2, height / 2])
            .scale(200)
            .center([0, 25]);

        const pathGenerator = d3.geoPath().projection(projection);

        const colorScale = d3.scaleSequential()
            .domain([0, 100])
            .interpolator(d3.interpolateRgb("white", "blue"));

        const yearInput = document.getElementById("year");
        const yearValue = document.getElementById("yearValue");

        yearInput.addEventListener("input", function () {
            yearValue.textContent = yearInput.value;
            updateMap();
        });

        function updateMap() {
            const selectedYear = parseInt(yearInput.value) || 1980;
            const selectedVariable = document.getElementById("variable").value; // Get the selected variable from the dropdown menu

            d3.csv("assets/Final.csv", (d) => {
                return {
                    Entity: d.Entity,
                    Code: d.Code,
                    Year: +d.Year,
                    CellularSubscription: +d["Cellular Subscription"],
                    InternetUsersPercentage: +d["Internet Users(%)"],
                    NoOfInternetUsers: +d["No. of Internet Users"],
                    BroadbandSubscription: +d["Broadband Subscription"]
                };
            }).then((data) => {
                const filteredData = data.filter((d) => d.Year === selectedYear);

                g.selectAll("path")
                    .style("fill", (d) => {
                        const countryData = filteredData.find((row) => row.Entity === d.properties.NAME);
                        if (countryData) {
                            // Use the selected variable to determine the color
                            const value = countryData[selectedVariable];
                            return colorScale(value);
                        } else {
                            return "gray";
                        }
                    });
            });
        }

        function createLegend() {
            const legendContainer = d3.select("#legend-container");
            legendContainer.selectAll("*").remove(); // Clear previous legend

            const legendWidth = 300;
            const legendHeight = 40;

            const legendSvg = legendContainer.append("svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight);

            const numTicks = 11;

            const colorScale = d3.scaleSequential(d3.interpolateBlues)
                .domain([0, 100]);

            const stops = d3.range(numTicks).map(d => d * 10);

            const legendScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, legendWidth]);

            const gradient = legendSvg.append("defs")
                .append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");

            gradient.selectAll("stop")
                .data(stops)
                .enter()
                .append("stop")
                .attr("offset", d => `${d}%`)
                .attr("stop-color", d => colorScale(d));

            legendSvg.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#legend-gradient)");

            legendSvg.selectAll(".legend-tick")
                .data(stops)
                .enter()
                .append("rect")
                .attr("x", d => legendScale(d))
                .attr("y", 0)
                .attr("width", legendWidth / (numTicks - 1))
                .attr("height", legendHeight)
                .style("fill", d => colorScale(d))
                .style("opacity", 0.8);

            legendSvg.selectAll(".legend-label")
                .data(stops)
                .enter()
                .append("text")
                .attr("x", d => legendScale(d) + (legendWidth / (numTicks - 1)) / 2)
                .attr("y", legendHeight / 2)
                .attr("dy", "0.35em")
                .style("text-anchor", "middle")
                .style("fill", "#000")
                .text(d => d);
        }

        function updateChart(selectedCountry) {
            const chartContainer = d3.select("#chart-container");
            chartContainer.selectAll("*").remove(); // Clear previous chart

            const margin = { top: 50, right: 20, bottom: 30, left: 40 };
            const chartWidth = +chartContainer.style("width").replace("px", "") - margin.left - margin.right;
            const chartHeight = +chartContainer.style("height").replace("px", "") - margin.top - margin.bottom;

            const x = d3.scaleBand()
                .rangeRound([0, chartWidth])
                .padding(0.1);

            const y = d3.scaleLinear()
                .rangeRound([chartHeight, 0]);

            const chartSvg = chartContainer.append("svg")
                .attr("width", chartWidth + margin.left + margin.right)
                .attr("height", chartHeight + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            d3.csv("assets/Final.csv", (d) => {
                return {
                    Entity: d.Entity,
                    Code: d.Code,
                    Year: +d.Year,
                    CellularSubscription: +d["Cellular Subscription"],
                    InternetUsersPercentage: +d["Internet Users(%)"],
                    NoOfInternetUsers: +d["No. of Internet Users"],
                    BroadbandSubscription: +d["Broadband Subscription"],
                };
            }).then((data) => {
                const selectedVariable = document.getElementById("variable").value;

                const filteredData = data.filter((d) => d.Entity === selectedCountry);

                const chartTitle = `${selectedCountry} - ${selectedVariable}`;

                x.domain(filteredData.map((d) => d.Year));
                y.domain([0, d3.max(filteredData, (d) => d[selectedVariable])]);

                chartSvg.selectAll(".bar")
                    .data(filteredData)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", (d) => x(d.Year))
                    .attr("y", (d) => y(d[selectedVariable]))
                    .attr("width", x.bandwidth())
                    .attr("height", (d) => chartHeight - y(d[selectedVariable]))
                    .attr("fill", "steelblue");

                chartSvg.append("g")
                    .attr("transform", `translate(0,${chartHeight})`)
                    .call(d3.axisBottom(x).tickValues(x.domain().filter((d, i) => i % 5 === 0)))
                    .selectAll("text")
                    .attr("y", 0)
                    .attr("x", -9)
                    .attr("dy", ".35em")
                    .attr("transform", "rotate(-90)")
                    .style("text-anchor", "end");

                chartSvg.append("g")
                    .call(d3.axisLeft(y));

                chartSvg.append("text")
                    .attr("class", "chart-title")
                    .attr("x", chartWidth / 2)
                    .attr("y", -20)
                    .style("text-anchor", "middle")
                    .text(chartTitle);
            });
        }


        d3.json("https://raw.githubusercontent.com/martynafford/natural-earth-geojson/master/110m/cultural/ne_110m_admin_0_countries.json").then(data => {
            g.selectAll("path")
                .data(data.features)
                .enter().append("path")
                .attr("d", pathGenerator)
                .style("fill", "gray")
                .attr("class", d => d.properties.SOVEREIGNT)
                .on("click", function (event, d) {
                    if (event.button === 0) {
                        const selectedYear = parseInt(yearInput.value) || 1980;
                        const selectedCountry = d.properties.SOVEREIGNT; // Get the country name from the clicked path
                        updateChart(selectedCountry); // Call the updateChart function with the selected country
                    }
                });

            updateMap();
            createLegend();
            updateChart();
        });
    </script>
</body>

</html>